import requests
from kivymd.app import MDApp
from kivymd.uix.screen import MDScreen
from kivymd.uix.button import MDRaisedButton, MDFlatButton
from kivymd.uix.textfield import MDTextField
from kivymd.uix.dialog import MDDialog
from kivymd.uix.menu import MDDropdownMenu
from kivymd.uix.spinner import MDSpinner
from kivy.uix.image import Image
from kivy.clock import Clock
from kivy.metrics import dp

class StormBanApp(MDApp):
    def build(self):
        self.theme_cls.primary_palette = "Green"
        self.theme_cls.theme_style = "Dark"
        screen = MDScreen()

        # 1. Fond d'√©cran
        screen.add_widget(Image(source='bg.jpg', allow_stretch=True, keep_ratio=False))

        # 2. Indicateur de chargement (Spinner)
        self.spinner = MDSpinner(
            size_hint=(None, None),
            size=(dp(46), dp(46)),
            pos_hint={'center_x': .5, 'center_y': .75},
            active=True
        )
        screen.add_widget(self.spinner)

        # 3. Champ Pays
        self.country_field = MDTextField(
            hint_text="Chargement des pays...",
            pos_hint={"center_x": 0.5, "center_y": 0.7},
            size_hint_x=0.6,
            readonly=True
        )
        screen.add_widget(self.country_field)

        # 4. Code et Num√©ro
        self.input_code = MDTextField(
            text="+",
            pos_hint={"center_x": 0.3, "center_y": 0.6},
            size_hint_x=0.15,
            readonly=True
        )
        self.input_num = MDTextField(
            hint_text="num√©ro de t√©l√©phone",
            pos_hint={"center_x": 0.6, "center_y": 0.6},
            size_hint_x=0.4,
            input_filter="int"
        )
        screen.add_widget(self.input_code)
        screen.add_widget(self.input_num)

        # 5. Bouton NEXT
        btn = MDRaisedButton(
            text="NEXT",
            pos_hint={"center_x": 0.5, "center_y": 0.45},
            md_bg_color=(0, 0.5, 0.2, 1),
            on_release=self.show_ban_message
        )
        screen.add_widget(btn)

        # Lancer le t√©l√©chargement apr√®s 1 seconde
        Clock.schedule_once(self.charger_pays, 1)

        return screen

    def charger_pays(self, *args):
        try:
            # API pour r√©cup√©rer les pays et codes
            url = "https://restcountries.com/v3.1/all?fields=name,idd"
            response = requests.get(url, timeout=10)
            donnees = response.json()

            # Trier les pays par nom alphab√©tique
            donnees.sort(key=lambda x: x['name']['common'])

            menu_items = []
            for pays in donnees:
                nom = pays['name']['common']
                root = pays['idd'].get('root', '')
                suffixes = pays['idd'].get('suffixes', [''])
                # On prend le premier suffixe pour simplifier
                code = root + suffixes[0]
                
                if code:
                    menu_items.append({
                        "viewclass": "OneLineListItem",
                        "text": f"{nom} ({code})",
                        "on_release": lambda x={'n': nom, 'c': code}: self.set_country(x),
                    })

            self.menu = MDDropdownMenu(caller=self.country_field, items=menu_items, width_mult=4)
            
            # Cacher le chargement une fois fini
            self.spinner.active = False
            self.spinner.opacity = 0
            self.country_field.hint_text = "Choisir le pays"
            self.country_field.bind(focus=self.open_menu)
        except Exception as e:
            self.spinner.active = False
            self.country_field.hint_text = "Erreur : V√©rifiez internet"

    def open_menu(self, instance, value):
        if value: self.menu.open()

    def set_country(self, data):
        self.country_field.text = data['n']
        self.input_code.text = data['c']
        self.menu.dismiss()

    def show_ban_message(self, *args):
        num = f"{self.input_code.text} {self.input_num.text}"
        self.dialog = MDDialog(
            title=num,
            text="Ce num√©ro ne peut plus utilis√© WhatsApp pour cause d'insolence üö´\n\nVeuillez contacter le Dr. Blood Angel üî•",
            buttons=[
                MDFlatButton(text="CANCEL", text_color=(0, 0.5, 0.2, 1)),
                MDFlatButton(text="SUPORTE", text_color=(0, 0.5, 0.2, 1)),
            ],
        )
        self.dialog.open()

StormBanApp().run()
